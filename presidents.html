<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Presidents of State 2128 — WOS</title>
  <style>
    *{box-sizing:border-box}
    body{
      margin:0; color:#eef2ff;
      font:16px/1.6 ui-sans-serif,system-ui,-apple-system,Segoe UI,Inter,Roboto,"Noto Sans",Arial;
      background: radial-gradient(1100px 560px at 50% -10%, #1a2147 0%, #0b1030 42%, #060915 100%);
    }
    .pwrap{ max-width:1000px; margin:0 auto; padding:40px 20px; }
    header{text-align:center; margin-bottom:1.25rem}
    header h1{margin:0 0 .4rem; font-size:clamp(1.4rem,1.8vw + 1rem,2.2rem); letter-spacing:.5px; text-transform:uppercase}
    header p.sub{margin:.25rem 0 0; opacity:.9}

    /* Grid: aim for 3-up on desktop */
    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap:24px;
      align-items:start;
      min-height:120px;
    }

    :root{ --gold:#d4b06a; }

    /* Card + flip skeleton */
    .card{
      --ally:#9b1c31;
      position:relative;
      width:100%;
      aspect-ratio:2/3;
      border-radius:18px;
      perspective: 1200px;
    }
    .flip{
      position:relative; inset:0;
      width:100%; height:100%;
      transform-style: preserve-3d;
      transition: transform .8s cubic-bezier(.2,.7,.2,1);
      border-radius:18px;
      box-shadow:0 16px 30px rgba(0,0,0,.45);
    }
    .card.is-flipped .flip{ transform: rotateY(180deg); }

    .face{
      position:absolute; inset:0;
      border-radius:18px; overflow:hidden;
      backface-visibility:hidden;
      background:#0f1633; border:3px solid var(--ally);
    }
    .face::before{
      content:""; position:absolute; inset:0; border-radius:14px; margin:4px;
      box-shadow: inset 0 0 0 3px rgba(212,176,106,.8); pointer-events:none;
    }

    /* Front visuals */
    .front .img{ position:absolute; inset:0; background:#0b1030 center/cover no-repeat; }
    .grad{ position:absolute; left:0; right:0; bottom:0; height:38%;
           background:linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.6) 35%, rgba(0,0,0,.82)); }
    .ribbon{ position:absolute; top:12px; left:50%; transform:translateX(-50%); padding:6px 10px;
             font-weight:800; font-size:12px; color:#fff; border-radius:10px;
             background:linear-gradient(180deg, #e85757, #b42a2a); box-shadow:0 6px 12px rgba(0,0,0,.35); }
    .glow{ position:absolute; inset:-6px; border-radius:22px; pointer-events:none;
           box-shadow:0 0 36px 12px rgba(255,0,0,.35); }

    /* Plaque: larger, clearer */
    .plaque{ position:absolute; left:50%; bottom:14px; transform:translateX(-50%); text-align:center;
             min-width:70%; padding:12px 16px; border-radius:14px;
             background:linear-gradient(180deg, rgba(212,176,106,.95), rgba(138,100,40,.98));
             color:#2e2412; border:1px solid rgba(0,0,0,.35);
             box-shadow: inset 0 1px 0 rgba(255,255,255,.4), 0 6px 14px rgba(0,0,0,.35); }
    .plaque .name{ font-weight:900; letter-spacing:.4px; font-size:clamp(1rem, 0.6vw + .95rem, 1.15rem); }
    .plaque .meta{ margin-top:4px; font-size:clamp(.88rem, 0.4vw + .8rem, 1rem); opacity:.96; }
    .badge{ display:inline-flex; align-items:center; gap:6px; font-weight:700; }
    .badge .dot{ width:8px; height:8px; border-radius:50%; background:var(--ally); box-shadow:0 0 8px var(--ally); }

    /* Back face */
    .back{
      transform: rotateY(180deg);
      display:flex; flex-direction:column; padding:16px;
      background:linear-gradient(180deg, #11183a, #0f1532 70%);
    }
    .back h3{margin:0 0 .25rem; font-size:1.05rem; letter-spacing:.3px}
    .back .term{opacity:.9; font-size:.95rem; margin-bottom:.6rem}
    .back .scroll{
      position:relative; flex:1; overflow:auto; padding-right:8px;
      mask-image: linear-gradient(180deg, rgba(0,0,0,1) 85%, rgba(0,0,0,0));
      -webkit-mask-image: linear-gradient(180deg, rgba(0,0,0,1) 85%, rgba(0,0,0,0));
    }
    .back .scroll p{margin:0; font-size:1rem; white-space:pre-wrap; line-height:1.6}

    /* Flip control (hidden on hover devices) */
    .controls{
      position:absolute; top:10px; right:10px; z-index:3;
      display:flex; gap:8px;
    }
    .btn{
      appearance:none; border:1px solid rgba(255,255,255,.25); background:rgba(8,12,32,.5);
      color:#fff; border-radius:10px; padding:6px 10px; font-weight:700; font-size:12px;
      cursor:pointer;
    }
    .btn:focus-visible{ outline:2px solid #a5b4ff; outline-offset:2px; }

    /* Featured current card = 2x2 on desktop only */
    @media (min-width: 1024px){
      .card.featured{ grid-column: span 2; grid-row: span 2; }
    }
    /* Hover-to-flip on devices with hover */
    @media (hover: hover) and (pointer: fine) {
      .card:hover .flip { transform: rotateY(180deg); }
      .card .controls { display:none; }
    }

    .note{ margin-top:20px; font-size:14px; opacity:.8; text-align:center; }
    a{color:#a5b4ff;text-decoration:underline} a:hover{color:#fff;text-decoration:none}
  </style>
</head>
<body>
  <!-- shared nav -->
  <div id="nav-placeholder"></div>
  <script>
    fetch('/nav.html').then(r=>r.text()).then(h=>{
      document.getElementById('nav-placeholder').innerHTML=h;
    });
  </script>

  <main class="pwrap" id="main">
    <header>
      <h1>Presidents of State 2128</h1>
      <p class="sub">Rotating presidency chosen by alliance councils. Current president is featured. Flip any card to read the bio in your language.</p>
    </header>

    <section class="grid" aria-label="Presidential portraits" id="cards">
      <p style="opacity:.85">Loading presidents…</p>
    </section>

    <p class="note">
      Content loads from our live sheet. Add rows (or new <code>bio-xx</code> columns) in Google Sheets — no redeploy needed.
    </p>
  </main>

  <!-- shared footer -->
  <div id="footer-placeholder"></div>
  <script>
    fetch('/footer.html').then(r=>r.text()).then(html=>{
      document.getElementById('footer-placeholder').innerHTML = html;
    });
  </script>

  <script>
    // ====== Config ======
    const EXEC_URL = 'https://script.google.com/macros/s/AKfycbyuU12nPaJKJkjf7xHs_CCURUPxlrG0hTKyoYQQhgC3BZGq40rKJCSiBZWBOY1m2xWW/exec';
    const SITE_DEFAULT_LANG = 'en';

    // ====== Language helpers ======
    function getQueryLang() {
      const p = new URLSearchParams(location.search).get('lang');
      return p ? p.toLowerCase().slice(0,2) : null;
    }
    const langPref = (() => {
      const q = getQueryLang();
      if (q) { localStorage.setItem('wos_lang', q); return q; }
      const stored = localStorage.getItem('wos_lang');
      if (stored) return stored;
      const nav = navigator.language || navigator.userLanguage || 'en';
      return (nav || 'en').toLowerCase().slice(0,2);
    })();

 // ====== Bio picker: preferred -> English -> site default -> first non-empty
function pickBio(row, preferred) {
  const entries = Object.entries(row).filter(([k,v]) =>
    /^bio([-_][a-z]{2})?$/i.test(String(k).trim()) && v && String(v).trim().length
  );
  if (!entries.length) return '';

  const map = {};
  for (const [rawKey, v] of entries){
    const k = String(rawKey).trim().toLowerCase();
    if (k === 'bio' || k === 'bio-en' || k === 'bio_en') {
      map['en'] = String(v).trim(); // treat plain "bio" as English
    } else {
      const code = k.split(/[-_]/)[1];
      if (code) map[code] = String(v).trim();
    }
  }

  // Order: preferred -> English -> site default -> any
  if (preferred && map[preferred]) return map[preferred];
  if (map['en']) return map['en'];
  if (map[SITE_DEFAULT_LANG]) return map[SITE_DEFAULT_LANG];
  return Object.values(map)[0] || '';
}


    // ====== Dates: parse + format
    function toDate(val){
      if (!val) return null;
      const v = String(val).trim();
      if (!v || /present|now/i.test(v)) return new Date(8640000000000000); // far future
      const d1 = new Date(v);
      if (!isNaN(d1)) return d1;
      const m = v.match(/^(\d{1,2})[.\-\/](\d{1,2})[.\-\/](\d{4})$/);
      if (m){ const [_, d, mo, y]=m; return new Date(+y, +mo-1, +d); }
      return null;
    }
    function niceDate(val){
      if (!val) return '—';
      if (/present|now/i.test(String(val))) return 'Present';
      const d = new Date(val);
      if (isNaN(d)) return String(val);
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yyyy = d.getFullYear();
      return `${dd}.${mm}.${yyyy}`;
    }

    // ====== Ordering
    function normalizeRow(r, idx){
      return { ...r, __index: idx, __start: toDate(r.term_start) };
    }
    function sortPresidents(rows){
      const isCur = r => String(r.is_current).toLowerCase()==='true' || String(r.draft).toLowerCase()==='true';
      const current = rows.find(isCur);
      const others = rows.filter(r => r !== current);
      others.sort((a,b)=>{
        const as=a.__start, bs=b.__start;
        if (as && bs) return bs - as;
        if (as && !bs) return -1;
        if (!as && bs) return 1;
        return b.__index - a.__index;
      });
      return current ? [current, ...others] : others;
    }

    // ====== Alliance color (robust + fallback)
    function normalizeAllianceKey(raw){
      const s = String(raw ?? '').toLowerCase();
      // letters only; collapse spaces/dashes; take code-like forms too
      return s.replace(/[^a-z]/g,'');
    }
    function hashColor(key){
      // deterministic pleasant HSL -> CSS color string
      let h=0; for (let i=0;i<key.length;i++){ h = (h*31 + key.charCodeAt(i))>>>0; }
      const hue = h % 360;
      const s = 65, l = 45;
      return `hsl(${hue}deg ${s}% ${l}%)`;
    }
    function allianceColor(r){
      if (r.accent_color) return r.accent_color;
      const key = normalizeAllianceKey(r.alliance_name ?? r.alliance ?? '');
      // Known palette (codes and names)
      const M = {
        // Codes
        whl:'#2B6CC0', ooo:'#9B1C31', hav:'#FF8C00', nwo:'#2C7A7B', snk:'#B7791F',
        jst:'#2563EB', eur:'#6B46C1', lfg:'#16A34A', dwr:'#0EA5E9', car:'#D97706', trm:'#7C3AED',
        // Names (letters-only)
        whales:'#2B6CC0',
        outoforder:'#9B1C31',
        havoc:'#FF8C00',
        newworldorder:'#2C7A7B',
        snackkingdom:'#B7791F',
        justice:'#2563EB',
        europa:'#6B46C1',
        lookingforgroup:'#16A34A',
        vengefulmoon:'#7C3AED',
        dwr:'#0EA5E9',
        caramba:'#D97706'
      };
      // Try first 3 letters as code too
      const code3 = key.slice(0,3);
      return M[key] || M[code3] || '#9B1C31' /* default */ ;
      // If you want a generated fallback instead of default crimson, swap to:
      // return M[key] || M[code3] || hashColor(key || 'ally');
    }

    function cardHTML(r, isFeatured){
      const ally = allianceColor(r);
      const name = r.name || r.id || 'Unknown';
      const title = r.short_title || '';
      const allianceLabel = r.alliance_name || r.alliance || '';
      const termStart = niceDate(r.term_start);
      const termEnd = r.term_end ? niceDate(r.term_end) : '';
      const img = r.portrait || r.portrait_url || '/assets/presidents/placeholder.png';
      const isCurrent = String(r.is_current).toLowerCase()==='true' || String(r.draft).toLowerCase()==='true';
      const bio = pickBio(r, langPref);
      const ariaFront = `${name}, President of State 2128`;
      const currentRibbon = isCurrent ? `<div class="ribbon" aria-hidden="true">CURRENT PRESIDENT</div>` : '';

      return `
      <article class="card ${isFeatured?'featured':''} ${isCurrent?'current':''}" style="--ally:${ally}" data-id="${r.id||''}">
        <div class="flip">
          <div class="face front" aria-label="${ariaFront}">
            ${isCurrent ? '<div class="glow" aria-hidden="true"></div>' : ''}
            <div class="img" role="img" style="background-image:url('${img}')"></div>
            ${currentRibbon}
            <div class="grad" aria-hidden="true"></div>
            <div class="plaque">
              <div class="name">${name.toUpperCase()}</div>
              <div class="meta">
                ${allianceLabel ? `<span class="badge"><span class="dot"></span> ${allianceLabel}</span> • ` : ''}
                ${title ? `${title} • ` : ''}
                Term: ${termStart} ${termEnd ? `– ${termEnd}` : ''}
              </div>
            </div>
            <div class="controls"><button class="btn flip-btn" aria-label="Flip card to read bio">Flip</button></div>
          </div>
          <div class="face back" aria-hidden="true">
            <div class="controls"><button class="btn flip-btn" aria-label="Flip card to front">Front</button></div>
            <h3>${name}</h3>
            <div class="term">${allianceLabel ? `${allianceLabel} • ` : ''}${title ? `${title} • ` : ''}Term: ${termStart} ${termEnd ? `– ${termEnd}` : ''}</div>
            <div class="scroll"><p>${bio || '<em>(No bio available in your language — showing default.)</em>'}</p></div>
          </div>
        </div>
      </article>`;
    }

    function mountCards(rows){
      const grid = document.getElementById('cards');
      grid.innerHTML = '';

      if (!rows.length){
        grid.innerHTML = '<p style="opacity:.85">No presidents found.</p>';
        return;
      }

      const normalized = rows.map(normalizeRow);
      const ordered = sortPresidents(normalized);

      ordered.forEach((r, i)=>{
        const isFeatured = (i === 0); // first = current (featured on desktop)
        grid.insertAdjacentHTML('beforeend', cardHTML(r, isFeatured));
      });

      // Flip controls for touch devices only
      if (window.matchMedia('(hover: none)').matches) {
        grid.addEventListener('click', (e)=>{
          const btn = e.target.closest('.flip-btn');
          if (!btn) return;
          const card = btn.closest('.card');
          card.classList.toggle('is-flipped');
        });
      }
    }

    // ====== Load data (clear error reporting) ======
    ;(async function(){
      const grid = document.getElementById('cards');
      try{
        const bust = Date.now();
        const res = await fetch(`${EXEC_URL}?v=${bust}`, { cache: 'no-store' });

        const raw = await res.text();
        console.log('Exec RAW (first 300):', raw.slice(0,300));

        let data;
        try { data = JSON.parse(raw); }
        catch (e) { throw new Error('Bad JSON from exec: ' + e.message); }

        const rows = Array.isArray(data)
          ? data
          : (data.presidents || data.rows || data.data || []);

        if (!Array.isArray(rows)) throw new Error('No array found at data.presidents / data.rows / data.data');

        console.log('Parsed rows length:', rows.length);
        mountCards(rows);
      }catch(err){
        console.error('Failed to load presidents:', err);
        grid.innerHTML = '<p style="opacity:.85">Couldn’t load presidents: ' + (err?.message || String(err)) + '</p>';
      }
    })();
  </script>
</body>
</html>
